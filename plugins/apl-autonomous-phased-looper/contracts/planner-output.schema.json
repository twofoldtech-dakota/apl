{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/twofoldtech-dakota/apl/contracts/planner-output.schema.json",
  "title": "PlannerOutput",
  "description": "Output contract for the planner agent. Contains the decomposed task list with dependencies, parallel groups, and applied patterns.",
  "type": "object",
  "required": ["tasks"],
  "properties": {
    "goal_analysis": {
      "$ref": "#/$defs/GoalAnalysis",
      "description": "Analysis of the original goal"
    },
    "strategy": {
      "$ref": "#/$defs/Strategy",
      "description": "Selected decomposition strategy"
    },
    "tasks": {
      "type": "array",
      "minItems": 1,
      "maxItems": 15,
      "description": "Ordered list of tasks to complete the goal",
      "items": {
        "$ref": "#/$defs/Task"
      }
    },
    "parallel_groups": {
      "type": "array",
      "description": "Groups of tasks that can be executed in parallel",
      "items": {
        "$ref": "#/$defs/ParallelGroup"
      }
    },
    "total_estimated_complexity": {
      "type": "string",
      "enum": ["simple", "medium", "complex"],
      "description": "Overall complexity assessment"
    },
    "patterns_applied": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "IDs of success patterns applied to this plan"
    },
    "anti_patterns_avoided": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "IDs of anti-patterns explicitly avoided"
    },
    "notes": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Additional notes or future considerations"
    },
    "status": {
      "type": "string",
      "enum": ["ready", "needs_clarification", "scope_warning"],
      "description": "Plan readiness status",
      "default": "ready"
    },
    "questions": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Clarification questions if status is 'needs_clarification'"
    },
    "suggested_phases": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Suggested phases if status is 'scope_warning'"
    }
  },
  "$defs": {
    "GoalAnalysis": {
      "type": "object",
      "description": "Parsed understanding of the goal",
      "properties": {
        "what": {
          "type": "string",
          "description": "The concrete deliverable"
        },
        "why": {
          "type": "string",
          "description": "The purpose (if stated)"
        },
        "scope": {
          "type": "string",
          "description": "Boundaries of the work"
        },
        "constraints": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Limitations or requirements"
        }
      }
    },
    "Strategy": {
      "type": "object",
      "description": "Selected decomposition approach",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Strategy name (e.g., 'Bottom-Up', 'Top-Down', 'Feature-Sliced')"
        },
        "rationale": {
          "type": "string",
          "description": "Why this strategy was chosen"
        }
      }
    },
    "Task": {
      "type": "object",
      "description": "A single implementable task",
      "required": ["id", "description", "success_criteria"],
      "properties": {
        "id": {
          "type": "integer",
          "minimum": 1,
          "description": "Unique task identifier within this plan"
        },
        "description": {
          "type": "string",
          "minLength": 10,
          "description": "Clear, actionable description of what to implement"
        },
        "success_criteria": {
          "type": "array",
          "minItems": 1,
          "maxItems": 10,
          "items": {
            "type": "string",
            "minLength": 5
          },
          "description": "Measurable criteria that define task completion"
        },
        "complexity": {
          "type": "string",
          "enum": ["simple", "medium", "complex"],
          "description": "Estimated complexity for model selection"
        },
        "dependencies": {
          "type": "array",
          "items": {
            "type": "integer",
            "minimum": 1,
            "description": "Must reference valid task IDs (starting from 1)"
          },
          "description": "IDs of tasks that must complete before this one",
          "default": []
        },
        "suggested_approach": {
          "type": ["string", "null"],
          "description": "Recommended approach from learned patterns, or null"
        },
        "estimated_files": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Files expected to be created or modified"
        },
        "verification_method": {
          "type": "string",
          "description": "How to verify task completion"
        }
      }
    },
    "ParallelGroup": {
      "type": "object",
      "description": "A group of tasks that can execute concurrently",
      "required": ["group", "task_ids"],
      "properties": {
        "group": {
          "type": "string",
          "pattern": "^[a-z]$",
          "description": "Single letter identifier (a-z)"
        },
        "task_ids": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "integer",
            "minimum": 1
          },
          "description": "Task IDs that belong to this group"
        },
        "description": {
          "type": "string",
          "description": "Description of what this group accomplishes"
        }
      }
    }
  },
  "examples": [
    {
      "goal_analysis": {
        "what": "REST API with JWT authentication",
        "scope": "Authentication endpoints only",
        "constraints": ["Must use JWT", "TypeScript required"]
      },
      "strategy": {
        "name": "Feature-Sliced",
        "rationale": "Matches learned patterns, enables parallelization"
      },
      "tasks": [
        {
          "id": 1,
          "description": "Initialize project with Express and TypeScript configuration",
          "success_criteria": [
            "package.json has express, typescript dependencies",
            "tsconfig.json configured for strict mode",
            "src/index.ts exists and compiles"
          ],
          "complexity": "simple",
          "dependencies": [],
          "suggested_approach": "Use standard Express + TypeScript setup",
          "estimated_files": ["package.json", "tsconfig.json", "src/index.ts"],
          "verification_method": "npm run build succeeds"
        },
        {
          "id": 2,
          "description": "Create User model with secure password storage",
          "success_criteria": [
            "User model has email, passwordHash, timestamps",
            "Password hashing uses bcrypt with cost factor 10+",
            "Model exports TypeScript interface"
          ],
          "complexity": "medium",
          "dependencies": [1],
          "suggested_approach": "Use bcrypt for hashing (learned pattern)",
          "estimated_files": ["src/models/User.ts", "src/types/user.ts"],
          "verification_method": "TypeScript compiles, unit tests pass"
        }
      ],
      "parallel_groups": [
        {"group": "a", "task_ids": [1]},
        {"group": "b", "task_ids": [2]}
      ],
      "total_estimated_complexity": "medium",
      "patterns_applied": ["sp_auth_jwt_001", "sp_password_bcrypt_001"],
      "anti_patterns_avoided": ["ap_security_plaintext_001"],
      "notes": ["Consider adding rate limiting in future iteration"],
      "status": "ready"
    }
  ]
}
